<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
</head>

<body>

  <div id="container">
    <video id="local" autoplay></video>

    <video id="remote" autoplay></video>

    <button id="call">call</button>
  </div>

	<script src="/socket.io/socket.io.js"></script>

  <script>
  	var socket = io.connect();

  	var myPeerConnection;
  	var remotePeerConnection;
  	var offer;

  	var PeerConnectionWindow = (window.RTCPeerConnection || window.mozRTCPeerConnection 
  	|| window.webkitRTCPeerConnection || window.msRTCPeerConnection);
  	var SessionDescription = (window.RTCSessionDescription || window.mozRTCSessionDescription 
  	|| window.webkitRTCSessionDescription || window.msRTCSessionDescription);


  	    function hasUserMedia() { 
  	   //check if the browser supports the WebRTC 
  	   return !!(navigator.getUserMedia || navigator.webkitGetUserMedia || 
  	      navigator.mozGetUserMedia || navigator.msGetUserMedia); 
  	}




  	if (hasUserMedia()) {

  	   var configuration = { 
  	      "iceServers": [{ "url": "stun:stun.1.google.com:19302" }] 
  	   }; 

  	   myPeerConnection = new PeerConnectionWindow(configuration);
  	   console.log(myPeerConnection);

  	   remotePeerConnection = new PeerConnectionWindow(configuration);
  	   console.log(remotePeerConnection);

  	   myPeerConnection.createOffer(gotDescription, onError);

  	   myPeerConnection.onicecandidate = function(evt){
  	      if(event.candidate){
  	         socket.emit('ice', JSON.stringify({'ice': evt.candidate}));
  	         remotePeerConnection.addIceCandidate(evt.candidate);
  	         console.log("connected my to remote");
  	      }
  	   };

  	   remotePeerConnection.onicecandidate = function(evt){
  	      if(event.candidate){
  	         socket.emit('ice', JSON.stringify({'ice': evt.candidate}));
  	         myPeerConnection.addIceCandidate(evt.candidate);
  	         console.log("connected my to remote");
  	      }
  	   };

  	   remotePeerConnection.onaddstream = function (evt) {
  	      console.log("on added stream");
  	      var remoteVid = document.getElementById('remote'); 

  	      remoteVid.src = window.URL.createObjectURL(evt.stream);
  	   }

  	   navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia
  	   || navigator.mozGetUserMedia || navigator.msGetUserMedia; 
  	   //enabling video and audio channels 
  	   navigator.getUserMedia({ video: true, audio: true }, function (stream) {  
  	      var video = document.getElementById('local');  
  	      // //inserting our stream to the video tag     
  	      video.src = window.URL.createObjectURL(stream);
  	      myPeerConnection.addStream(stream); 
  	   }, onError); 
  	} else { 
  	   alert("WebRTC is not supported"); 
  	}

  	function gotDescription(desc) {
  	   offer = desc
  	   myPeerConnection.setLocalDescription(offer, myPeerConnLocalDescSet, onError);
  	   socket.emit('description', JSON.stringify({'sdp': desc}));
  	}

  	function onError(err){
  	   console.log(err);
  	}

  	function myPeerConnLocalDescSet(){
  	   remotePeerConnection.setRemoteDescription(offer, remotePeerConnRemoteDescSet,onError);
  	}

  	function remotePeerConnRemoteDescSet(){
  	   remotePeerConnection.createAnswer(onAnswerCreated, onError);
  	}

  	function onAnswerCreated(description){
  	   answer = description;
  	   remotePeerConnection.setLocalDescription(answer, remotePeerLocalDescSet,onError);
  	}

  	function remotePeerLocalDescSet(){
  	   myPeerConnection.setRemoteDescription(answer, myPeerRemoteDescSet,onError);
  	}

  	function myPeerRemoteDescSet(){
  	   console.log('did we get it?');
  	}

  	

  </script>
</body>
</html>