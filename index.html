<!DOCTYPE html>
<html>
    <head>
      <meta charset="UTF-8">
      <script src="https://socket.io-client/socket.io.js"></script>
      <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    </head>
    <body>
        <video id="localVideo" autoplay></video>
        <div id="remotesVideos"></div>

        <script>
          var configuration = {
            'iceServers': [{
              'urls': 'stun:stun.l.google.com:19302'
            }]
          };

          // Create a random room if not already present in the URL.
          var isInitiator;
          var room = window.location.hash.substring(1);
          if (!room) {
            room = window.location.hash = randomToken();
          }

          /****************************************************************************
          * Signaling server
          ****************************************************************************/

          // Connect to the signaling server
          var socket = io.connect();

          socket.on('ipaddr', function(ipaddr) {
            console.log('Server IP address is: ' + ipaddr);
            // updateRoomURL(ipaddr);
          });

          socket.on('created', function(room, clientId) {
            console.log('Created room', room, '- my client ID is', clientId);
            isInitiator = true;
            grabWebCamVideo();
          });

          socket.on('joined', function(room, clientId) {
            console.log('This peer has joined room', room, 'with client ID', clientId);
            isInitiator = false;
            createPeerConnection(isInitiator, configuration);
            grabWebCamVideo();
          });

          // socket.on('full', function(room) {
          //   alert('Room ' + room + ' is full. We will create a new room for you.');
          //   window.location.hash = '';
          //   window.location.reload();
          // });

          socket.on('ready', function(room) {
            console.log('Socket is ready ', room);
            createPeerConnection(isInitiator, configuration);
          });

          socket.on('log', function(array) {
            console.log.apply(console, array);
          });

          socket.on('message', function(message) {
            console.log('Client received message:', message);
            signalingMessageCallback(message);
          });

          // Join a room
          socket.emit('create or join', room);

          if (location.hostname.match(/localhost|127\.0\.0/)) {
            socket.emit('ipaddr');
          }

          /****************************************************************************
          * User media (webcam)
          ****************************************************************************/

          function grabWebCamVideo() {
            console.log('Getting user media (video) ...');
            navigator.mediaDevices.getUserMedia({
              audio: false,
              video: true
            })
            .then(gotStream)
            .catch(function(e) {
              alert('getUserMedia() error: ' + e.name);
            });
          }

          function gotStream(stream) {
            console.log('getUserMedia video stream URL:', window.URL.createObjectURL(stream));
            window.stream = stream; // stream available to console
            document.querySelector('#localVideo').srcObject = stream;
          }

          /****************************************************************************
          * WebRTC peer connection and data channel
          ****************************************************************************/

          var peerConn;

          function signalingMessageCallback(message) {
            if (message.type === 'offer') {
              console.log('Got offer. Sending answer to peer.');
              peerConn.setRemoteDescription(new RTCSessionDescription(message), function() {}, logError);
              peerConn.createAnswer(onLocalSessionCreated, logError);

            } 

            if (message.type === 'answer') {
              console.log('Got answer.');
              peerConn.setRemoteDescription(new RTCSessionDescription(message), function() {}, logError);

            }

            if (message.type === 'candidate') {
              peerConn.addIceCandidate(new RTCIceCandidate({
                candidate: message.candidate
              }));

            } 

            if (message === 'bye') {
              // TODO: cleanup RTC connection?
            }
          }

          function createPeerConnection(isInitiator, config) {
            console.log('Creating Peer connection as initiator?', isInitiator, 'config:', config);
            peerConn = new RTCPeerConnection(config);

            // send any ice candidates to the other peer
            peerConn.onicecandidate = function(event) {
              console.log('icecandidate event:', event);
              if (event.candidate) {
                sendMessage({
                  type: 'candidate',
                  label: event.candidate.sdpMLineIndex,
                  id: event.candidate.sdpMid,
                  candidate: event.candidate.candidate
                });
              } else {
                console.log('End of candidates.');
              }
            };

            if (isInitiator) {
              console.log('Creating an offer');
              peerConn.addStream(window.stream);

              peerConn.createOffer(onLocalSessionCreated, logError, {
                  OfferToReceiveAudio: true,
                  OfferToReceiveVideo: true
              });
            }
          }

          function onLocalSessionCreated(desc) {
            console.log('local session created:', desc);
            peerConn.setLocalDescription(desc, function() {
              console.log('sending local desc:', peerConn.localDescription);
              sendMessage(peerConn.localDescription);
            }, logError);
          }

          /**
          * Send message to signaling server
          */
          function sendMessage(message) {
            console.log('Client sending message: ', message);
            socket.emit('message', message);
          }

          function logError(err) {
            console.log(err.toString(), err);
          }

          function randomToken() {
            return Math.floor((1 + Math.random()) * 1e16).toString(16).substring(1);
          }
        </script>
    </body>
</html>